# 对外服务少引入解释代码

又一个蛋疼的周五, 摸摸鱼, 划划水多好, 写写简单需求, 整理下代码, 就到周六日了. 工作到现在我有一个大忌"周五改代码上线", 但因为一个 log4j2 的重大漏洞我必须上线修复. 真的是蛋疼啊.

## log4j 的蛋疼操作

日志框架明明功能很简单, 扩充功能也是有限的, 非要引入需要"解释"再结果进行"执行"的操作. 这就引入了巨大风险, 加上 JNDI 框架的强大, 一个解释性语言出现了. 可以开始快乐的"注入"代码了, 互联网欢腾了.

自己使用 log4j 测试了下代码, 感觉 log4j 的执行流程大概是先处理日志的拼接, 再执行 lookup; 据说这个 lookup 是递归实现的, 但这个我就没有测试了. 虽然不知道为啥要支持这个功能, 但我能接受的流程是, 先做 lookup 再拼接日志; 这样的流程注入的概率小很多, 但可能引起日志打印顺序不对, 但安全系数好很多.

## 个人观点

一个项目没有极特殊理由不要引入动态代码, 脚本, 有特殊规则的解释器和执行器. 这种功能设计简单通常没啥影响, 当功能打到完备的时候稍不注意就是一个漏洞, 还是个大洞. fastjson 多个漏洞都是类似问题引起的, 这回 log4j2 也是一个类似的功能.

我曾经在一个项目里边引入动态脚本. 为了尽量保证安全, 我在代码中写了多个规则防止引入高风险代码, 包括 system,  quit, exit, sleep 等, 还限制了脚本长度. 而项目主要的安全保证是靠"内部项目"做到的, 使用人员都是公司员工, 才可以保证安全.

所有对外提供的服务都要秉持着一个原则, 我对外提供的是一个有限服务不是一台完整的服务器. 用户的输入都只是普通的字符; 对技术来说这些输入只是判断条件, 而不是需要执行的代码. 所有执行逻辑都需要开发人员进行控制. 最后就是不要引入可执行的代码.

突然想到 leetcode 是不是可以搞点东西, 但猜测提交的代码都是运行在沙箱中的, 不可能直接运行, 直接的化那就真的 happy 了.
