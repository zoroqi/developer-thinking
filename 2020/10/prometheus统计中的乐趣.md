# prometheus统计中的乐趣

当初接收一个老项目, 有4w+的代码, 2w+废弃代码(已下线功能但没删除). 看了将近一周大概了解代码主要逻辑. 后边靠着需求用了1个多月才完全熟悉这个破项目. 时间宽裕了发现硬看代码太费劲了, 各种神奇逻辑不知道在干啥. 想想有啥快速方式熟悉业务代码, 发现靠着统计方式熟悉业务代码是个很好的方案.

主要使用的工具就是prometheus\+Grafana的方案.

因为很多工程项目说白了就是数据库的展示层, 这里数据库指得是外部数据, 可以关系型数据库, NoSql, NewSql, 文件, 第三方接口等. 针对从外部获得的数据进行一些转换, 过滤, 排序, 组合等操作. 而项目维护久了, 可能就会腐化, 最后一团乱麻, 外加没有文档或文档太多(废弃文档的存在), 要是想完全理解代码和业务需要庞大的时间.

腐败项目经常的面对问题就是, 接口参数从一个变为多个最后直接发展为有20几个参数的json, 查询接口从单一数据源变为十几个数据源; 业务上各种特殊过滤, 小判断. 而这些都是当初为了解决某个特殊的问题而打的补丁, 一个特殊的需求的临时解决方案, 业务的变更但老代码并没有移除, 等等. 这些都引起代码阅读的困难. 罗马不是一天建成的, 屎山不是一天堆成的, 需要有工具来快速知道代码的大致逻辑.

而有了统计上的辅助可以知道很多分支的隐含关系, 可以辅助业务的调整, 知道业务之间的耦合关系. 针对接口和查询数据源添加监控可以发现很多代码中特殊关系. 比如:
* 一个第三方接口从代码上看和每一个流程都有关系, 但从监控上看只和一个流程有关系
* 一个第三方接口从代码上和每个流程都有关系, 但统计上没有调用. 和调用参数有关
* 一个很大的内存cache, 启动会加载到内存, 但没有查询或命中率为0
* 代码上一定会执行的逻辑, 但没有执行效果.
* 凌晨2点的数据抖动
* 一个接口会调用, 但从统计上不调用不会对业务产生影响

观察prometheus的统计数据, 有时候真的会上瘾. 统计结果可以反映很多有意思的数据, 发现系统使用者的一些特殊癖好, 没需求的时候就各种统计指标加来加去借此发现有意思的东西.

prometheus很多时候监控性能指标为主, 例如接口耗时, qps, 失败率等, 这些方便知道无法挂了. 但更多需要监控是业务上的变动, 检索服务的平均查询量, 系统匹配规则统计, 推荐系统召回量, 打标系统中标签分布等, 这些都没啥技术体现, 但是比技术指标更能反映服务的运行状况, 技术指标的抖动都会成倍的反映在业务指标上.

prometheus监控采用的抽样方案其实开发成本和性能损失都很低, 结合Grafana可以快速画个图来发现数据之间的关系.

当面向prometheus设计代码的时候必须做出合理的抽象, 方便添加统计指标, 不然就要各种ctrl c/v大法来添加指标, 这会很丑陋的. spring下可以使用aop,  代理模式也可以实现.

当然这里所有都是建立在接手已经腐败的项目且没有详细交接的前提下的一种方案.
